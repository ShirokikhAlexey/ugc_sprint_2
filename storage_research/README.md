## Исследование по выбору хранилища для лайков

В ходе тестирования была исследована скорость загрузки данных 
из баз данных mongodb и postgresql при различных конфигурациях. 
Была исследована средняя скорость загрузки среднего рейтинга фильма, числа оценок на фильме и 
списка пользовательских оценок при различном числе записей в базе.

## Объем данных
Для каждой конфигурации были проведены тесты для случая 100000 (100 пользователей и 1000 фильмов),
1000000 (100 пользователей и 10000 фильмов) и 10000000 (1000 пользователей и 10000 фильмов) записей в базе.

## Запуск инфраструктуры
### Запуск кластера mongodb
Выполняем команды внутри storage_research/mongo_cluster
```bash
docker-compose -f full_cluster.yaml up -d --build
```
После того как контейнеры подняты, выполним настройку кластера
```bash
./prepare-mongo.sh
```

### Запуск кластера postgresql
Выполняем команды внутри storage_research/pg_cluster
```bash
docker-compose -f pg_cluster.yaml up -d --build
```

### Запуск 1 ноды mongodb
Выполняем команды внутри storage_research/mongo_cluster
```bash
docker-compose -f one-node-mongo.yaml up -d --build
```

### Запуск 1 ноды postgresql
Выполняем команды внутри storage_research/pg_cluster
```bash
docker-compose up -d --build
```

## Запуск тестов

### Генерируем данные
Количество данных конфигурится в файле config.py

1) Устанавливаем зависимости из requirements.txt
2) Запускаем генерацию данных для mongodb
```bash
python3 generate_mongo_data.py
```
3) Запускаем генерацию данных для Postgresql
```bash
python3 generate_pg_data.py
```

### Запуск тестов
1) Запуск для mongodb
```bash
ptyhon3 read_data_mongo.py
```

2) Запуск для postgresql
```bash
ptyhon3 read_data_pg.py
```

## Результаты
Данные усреднялись по 10 и 100 запросам.

### Mongodb, 1 нода

| Число записей в базе | Поле запроса | Число тестов | Среднее время загрузки (c) |
| ------------- | ----- | ----- | ----- |
| 100000     | movie avg rating | 10 | 0.061 |
| 100000     | movie rating count | 10 |  0.054 |
| 100000     | movie liked by user | 10 | 0.059 |
| 100000     | movie avg rating | 100 | 0.059 |
| 100000     | movie rating count | 100 | 0.053 |
| 100000     | movie liked by user | 100 | 0.06 |
| 1000000    | movie avg rating | 10 | 0.561 |
| 1000000    | movie rating count | 10 | 0.509 |
| 1000000    | movie liked by user | 10 | 0.567 |
| 1000000    | movie avg rating | 100 | 0.552 |
| 1000000    | movie rating count | 100 | 0.507 |
| 1000000    | movie liked by user | 100 | 0.557 |
| 10000000   | movie avg rating | 10 | 5.482 |
| 10000000   | movie rating count | 10 | 5.093 |
| 10000000   | movie liked by user | 10 | 4.911 |
| 10000000   | movie avg rating | 100 | 5.369 |
| 10000000   | movie rating count | 100 | 4.937 |
| 10000000   | movie liked by user | 100 | 4.844 |



### postgresql, 1 нода

| Число записей в базе | Поле запроса | Число тестов | Среднее время загрузки (c) |
| ------------- | ----- | ----- | ----- |
| 100000     | movie avg rating | 10 | 0.011 |
| 100000     | movie rating count | 10 |  0.01 |
| 100000     | movie liked by user | 10 | 0.012 |
| 100000     | movie avg rating | 100 | 0.01 |
| 100000     | movie rating count | 100 | 0.01 |
| 100000     | movie liked by user | 100 | 0.012 |
| 1000000     | movie avg rating | 10 | 0.053 |
| 1000000     | movie rating count | 10 | 0.05 |
| 1000000     | movie liked by user | 10 | 0.088 |
| 1000000     | movie avg rating | 100 | 0.052 |
| 1000000     | movie rating count | 100 | 0.061 |
| 1000000     | movie liked by user | 100 | 0.086 |
| 10000000     | movie avg rating | 10 | 0.625 |
| 10000000     | movie rating count | 10 | 0.549 |
| 10000000     | movie liked by user | 10 | 0.569 |
| 10000000     | movie avg rating | 100 | 0.538 |
| 10000000     | movie rating count | 100 | 0.533 |
| 10000000     | movie liked by user | 100 | 0.539 |



### Mongodb, 2 ноды (2 шарда)

| Число записей в базе | Поле запроса | Число тестов | Среднее время загрузки (c) |
| ------------- | ----- | ----- | ----- |
| 100000     | movie avg rating | 10 | 0.063 |
| 100000     | movie rating count | 10 |  0.056 |
| 100000     | movie liked by user | 10 | 0.063 |
| 100000     | movie avg rating | 100 | 0.061 |
| 100000     | movie rating count | 100 | 0.057 |
| 100000     | movie liked by user | 100 | 0.064 |
| 1000000     | movie avg rating | 10 | 0.749 |
| 1000000     | movie rating count | 10 | 0.685 |
| 1000000     | movie liked by user | 10 | 0.719 |
| 1000000     | movie avg rating | 100 | 0.714 |
| 1000000     | movie rating count | 100 | 0.66 |
| 1000000     | movie liked by user | 100 | 0.712 |
| 10000000     | movie avg rating | 10 | 8.612 |
| 10000000     | movie rating count | 10 | 7.694 |
| 10000000     | movie liked by user | 10 | 7.32 |



### postgresql, 2 ноды (master и slave серверы)

| Число записей в базе | Поле запроса | Число тестов | Среднее время загрузки (c) |
| ------------- | ----- | ----- | ----- |
| 100000     | movie avg rating | 10 | 0.014 |
| 100000     | movie rating count | 10 |  0.014 |
| 100000     | movie liked by user | 10 | 0.017 |
| 100000     | movie avg rating | 100 | 0.013|
| 100000     | movie rating count | 100 | 0.013 |
| 100000     | movie liked by user | 100 | 0.015 |
| 1000000     | movie avg rating | 10 | 0.155 |
| 1000000     | movie rating count | 10 | 0.155 |
| 1000000     | movie liked by user | 10 | 0.162 |
| 1000000     | movie avg rating | 100 | 0.1 |
| 1000000     | movie rating count | 100 | 0.101 |
| 1000000     | movie liked by user | 100 | 0.122 |
| 10000000     | movie avg rating | 10 | 1.072 |
| 10000000     | movie rating count | 10 | 1.006 |
| 10000000     | movie liked by user | 10 | 0.995 |
| 10000000     | movie avg rating | 100 | 1.007 |
| 10000000     | movie rating count | 100 | 1.003 |
| 10000000     | movie liked by user | 100 | 0.994 |

### Вывод: 
В этом исследовании мы проанализировали и сравнили производительность с точки зрения времени чтения 
двух различных системам баз данных: документ-ориентированного NoSQL хранилища данных MongoDB, 
и объектно-реляционной базы данных с открытым исходным кодом, PostgreSQL. 

Каждая система баз данных была развернута в 2-х конфигурациях: в виде 1 ноды, и в виде кластера 
(шардированный на 2 сервера mongoDb, и master и slave сервер для PostgreSQL). 
Для оценки производительности систем была исследована средняя скорость загрузки среднего рейтинга фильма, числа оценок на фильме и 
списка пользовательских оценок при различном числе записей в базе. В результате было получено, 
что PostgreSQL превосходит MongoDB почти во всех случаях, так как время загрузки из MongoDB 
значительно превышает время загрузки из PostgreSQL в обоих конфигурациях. 


Следовательно, для использования в production-среде на данном этапе развития сервиса предпочтительно 
использовать PostgreSQL за счёт большей скорости чтения небольшого количества данных. Возможно при более точной 
настройке MongoDB покажет лучшие результаты, но для более конкретных выводов необходимо новое исследование, 
которое на данный момент не имеет практического смысла.
Тем не менее, для проекта была выбрана база данных MongoDB, поскольку именно о ней идёт речь в теоретических 
материалах курса. Также, с PostgreSQL весь поток студентов уже работал, а MongoDB - это новое решение, освоение 
которой поможет лучшему пониманию продуктов, присутствующих на рынке, так что для нашего учебного проекта эта система 
предпочтительнее. 